import React, { useState } from 'react';
import {
  Box,
  Button,
  Heading,
  Text,
  VStack,
  HStack,
  SimpleGrid,
  Card,
  CardBody,
  CardHeader,
  Badge,
  IconButton,
  useDisclosure,
  Modal,
  ModalOverlay,
  ModalContent,
  ModalHeader,
  ModalBody,
  ModalFooter,
  ModalCloseButton,
  FormControl,
  FormLabel,
  Input,
  Textarea,
  useToast,
  AlertDialog,
  AlertDialogBody,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogContent,
  AlertDialogOverlay,
  InputGroup,
  InputLeftElement,
  Link,
  Divider,
  useClipboard,
} from '@chakra-ui/react';
import { AddIcon, EditIcon, DeleteIcon, LinkIcon, ExternalLinkIcon, CopyIcon, CheckIcon } from '@chakra-ui/icons';
import { useQuery, useMutation, useQueryClient } from 'react-query';
import { wishlistAPI } from '../services/api';
import { WishlistItem } from '../types';
import { useAuth } from '../context/AuthContext';

const Wishlist: React.FC = () => {
  const queryClient = useQueryClient();
  const toast = useToast();
  const { user } = useAuth();
  const { isOpen, onOpen, onClose } = useDisclosure();
  const { isOpen: isDeleteOpen, onOpen: onDeleteOpen, onClose: onDeleteClose } = useDisclosure();
  const cancelRef = React.useRef<HTMLButtonElement>(null);

  const [selectedItem, setSelectedItem] = useState<WishlistItem | null>(null);
  const [itemToDelete, setItemToDelete] = useState<string | null>(null);
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    link: '',
    price: '',
  });

  const shareLink = user ? `${window.location.origin}/wishlist/${user._id}` : '';
  const { hasCopied, onCopy } = useClipboard(shareLink);

  // Fetch wishlist items
  const { data: items = [], isLoading } = useQuery({
    queryKey: ['wishlist'],
    queryFn: wishlistAPI.getAll,
  });

  // Create item mutation
  const createMutation = useMutation({
    mutationFn: wishlistAPI.create,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['wishlist'] });
      toast({
        title: 'Item added to wishlist',
        status: 'success',
        duration: 3000,
      });
      handleCloseModal();
    },
    onError: () => {
      toast({
        title: 'Error adding item',
        status: 'error',
        duration: 3000,
      });
    },
  });

  // Update item mutation
  const updateMutation = useMutation({
    mutationFn: ({ id, data }: { id: string; data: Partial<WishlistItem> }) =>
      wishlistAPI.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['wishlist'] });
      toast({
        title: 'Item updated',
        status: 'success',
        duration: 3000,
      });
      handleCloseModal();
    },
    onError: () => {
      toast({
        title: 'Error updating item',
        status: 'error',
        duration: 3000,
      });
    },
  });

  // Delete item mutation
  const deleteMutation = useMutation({
    mutationFn: wishlistAPI.delete,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['wishlist'] });
      toast({
        title: 'Item deleted',
        status: 'success',
        duration: 3000,
      });
      onDeleteClose();
    },
    onError: () => {
      toast({
        title: 'Error deleting item',
        status: 'error',
        duration: 3000,
      });
    },
  });

  const handleOpenModal = (item?: WishlistItem) => {
    if (item) {
      setSelectedItem(item);
      setFormData({
        name: item.name,
        description: item.description || '',
        link: item.link || '',
        price: item.price ? item.price.toString() : '',
      });
    } else {
      setSelectedItem(null);
      setFormData({
        name: '',
        description: '',
        link: '',
        price: '',
      });
    }
    onOpen();
  };

  const handleCloseModal = () => {
    setSelectedItem(null);
    setFormData({
      name: '',
      description: '',
      link: '',
      price: '',
    });
    onClose();
  };

  const handleSubmit = () => {
    if (!formData.name.trim()) {
      toast({
        title: 'Name is required',
        status: 'warning',
        duration: 3000,
      });
      return;
    }

    const submitData: any = {
      name: formData.name,
      description: formData.description || undefined,
      link: formData.link || undefined,
      price: formData.price ? parseFloat(formData.price) : undefined,
    };

    if (selectedItem) {
      updateMutation.mutate({ id: selectedItem._id, data: submitData });
    } else {
      createMutation.mutate(submitData);
    }
  };

  const handleDeleteClick = (itemId: string) => {
    setItemToDelete(itemId);
    onDeleteOpen();
  };

  const handleDeleteConfirm = () => {
    if (itemToDelete) {
      deleteMutation.mutate(itemToDelete);
      setItemToDelete(null);
    }
  };

  const handleCopyLink = () => {
    onCopy();
    toast({
      title: 'Link copied!',
      description: 'Share this link with friends and family',
      status: 'success',
      duration: 3000,
    });
  };

  if (isLoading) {
    return (
      <Box>
        <Heading mb={4}>My Wishlist</Heading>
        <Text>Loading...</Text>
      </Box>
    );
  }

  const reservedCount = items.filter((item: WishlistItem) => item.reserved).length;
  const availableCount = items.length - reservedCount;

  return (
    <Box>
      <VStack spacing={6} align="stretch">
        {/* Header */}
        <HStack justify="space-between">
          <Box>
            <Heading size="xl">My Wishlist</Heading>
            <Text color="gray.600">Manage your wishlist and share with others</Text>
          </Box>
          <Button leftIcon={<AddIcon />} colorScheme="blue" onClick={() => handleOpenModal()}>
            Add Item
          </Button>
        </HStack>

        {/* Stats */}
        {items.length > 0 && (
          <SimpleGrid columns={{ base: 1, md: 3 }} spacing={4}>
            <Card>
              <CardBody>
                <Text fontSize="sm" color="gray.600">Total Items</Text>
                <Text fontSize="2xl" fontWeight="bold">{items.length}</Text>
              </CardBody>
            </Card>
            <Card>
              <CardBody>
                <Text fontSize="sm" color="gray.600">Available</Text>
                <Text fontSize="2xl" fontWeight="bold" color="green.500">{availableCount}</Text>
              </CardBody>
            </Card>
            <Card>
              <CardBody>
                <Text fontSize="sm" color="gray.600">Reserved</Text>
                <Text fontSize="2xl" fontWeight="bold" color="orange.500">{reservedCount}</Text>
              </CardBody>
            </Card>
          </SimpleGrid>
        )}

        {/* Share Link */}
        {items.length > 0 && (
          <Card bg="blue.50" borderColor="blue.200" borderWidth="1px">
            <CardBody>
              <VStack align="stretch" spacing={3}>
                <HStack>
                  <LinkIcon color="blue.500" />
                  <Heading size="md">Share Your Wishlist</Heading>
                </HStack>
                <Text fontSize="sm" color="gray.700">
                  Share this link with friends and family so they can see your wishlist and reserve items
                </Text>
                <HStack>
                  <InputGroup>
                    <InputLeftElement>
                      <LinkIcon color="gray.500" />
                    </InputLeftElement>
                    <Input
                      value={shareLink}
                      isReadOnly
                      bg="white"
                      fontFamily="mono"
                      fontSize="sm"
                    />
                  </InputGroup>
                  <Button
                    leftIcon={hasCopied ? <CheckIcon /> : <CopyIcon />}
                    colorScheme={hasCopied ? 'green' : 'blue'}
                    onClick={handleCopyLink}
                    minW="120px"
                  >
                    {hasCopied ? 'Copied!' : 'Copy Link'}
                  </Button>
                </HStack>
              </VStack>
            </CardBody>
          </Card>
        )}

        {/* Wishlist Items */}
        {items.length === 0 ? (
          <Box textAlign="center" py={10}>
            <Text fontSize="lg" color="gray.500" mb={4}>
              Your wishlist is empty. Add items you'd like to receive!
            </Text>
            <Button leftIcon={<AddIcon />} colorScheme="blue" onClick={() => handleOpenModal()}>
              Add Your First Item
            </Button>
          </Box>
        ) : (
          <SimpleGrid columns={{ base: 1, md: 2, lg: 3 }} spacing={6}>
            {items.map((item: WishlistItem) => (
              <Card key={item._id} opacity={item.reserved ? 0.7 : 1}>
                <CardHeader>
                  <HStack justify="space-between">
                    <VStack align="start" spacing={0} flex={1}>
                      <Heading size="md">{item.name}</Heading>
                      {item.reserved && (
                        <Badge colorScheme="orange" mt={1}>Reserved</Badge>
                      )}
                    </VStack>
                    <HStack>
                      <IconButton
                        aria-label="Edit item"
                        icon={<EditIcon />}
                        size="sm"
                        onClick={() => handleOpenModal(item)}
                        isDisabled={item.reserved}
                      />
                      <IconButton
                        aria-label="Delete item"
                        icon={<DeleteIcon />}
                        size="sm"
                        colorScheme="red"
                        onClick={() => handleDeleteClick(item._id)}
                        isDisabled={item.reserved}
                      />
                    </HStack>
                  </HStack>
                </CardHeader>
                <CardBody>
                  <VStack align="stretch" spacing={3}>
                    {item.description && (
                      <Text fontSize="sm" color="gray.600">
                        {item.description}
                      </Text>
                    )}
                    
                    {item.price && (
                      <Text fontSize="lg" fontWeight="bold" color="green.600">
                        ‚Ç¨{item.price.toFixed(2)}
                      </Text>
                    )}

                    {item.link && (
                      <Link
                        href={item.link}
                        isExternal
                        color="blue.500"
                        fontSize="sm"
                        display="flex"
                        alignItems="center"
                      >
                        View Product <ExternalLinkIcon ml={1} />
                      </Link>
                    )}

                    {item.reserved && (
                      <>
                        <Divider />
                        <Text fontSize="sm" color="orange.600" fontWeight="medium">
                          üéÅ Someone has reserved this item for you!
                        </Text>
                      </>
                    )}
                  </VStack>
                </CardBody>
              </Card>
            ))}
          </SimpleGrid>
        )}
      </VStack>

      {/* Add/Edit Item Modal */}
      <Modal isOpen={isOpen} onClose={handleCloseModal} size="xl">
        <ModalOverlay />
        <ModalContent>
          <ModalHeader>{selectedItem ? 'Edit Item' : 'Add New Item'}</ModalHeader>
          <ModalCloseButton />
          <ModalBody>
            <VStack spacing={4}>
              <FormControl isRequired>
                <FormLabel>Item Name</FormLabel>
                <Input
                  value={formData.name}
                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                  placeholder="e.g., Wireless Headphones"
                />
              </FormControl>

              <FormControl>
                <FormLabel>Description</FormLabel>
                <Textarea
                  value={formData.description}
                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                  placeholder="Add details about the item..."
                  rows={3}
                />
              </FormControl>

              <FormControl>
                <FormLabel>Link</FormLabel>
                <Input
                  value={formData.link}
                  onChange={(e) => setFormData({ ...formData, link: e.target.value })}
                  placeholder="https://example.com/product"
                  type="url"
                />
              </FormControl>

              <FormControl>
                <FormLabel>Price</FormLabel>
                <InputGroup>
                  <InputLeftElement>
                    <Text color="gray.500">‚Ç¨</Text>
                  </InputLeftElement>
                  <Input
                    value={formData.price}
                    onChange={(e) => setFormData({ ...formData, price: e.target.value })}
                    placeholder="0.00"
                    type="number"
                    step="0.01"
                  />
                </InputGroup>
              </FormControl>
            </VStack>
          </ModalBody>

          <ModalFooter>
            <Button variant="ghost" mr={3} onClick={handleCloseModal}>
              Cancel
            </Button>
            <Button
              colorScheme="blue"
              onClick={handleSubmit}
              isLoading={createMutation.isPending || updateMutation.isPending}
            >
              {selectedItem ? 'Update' : 'Add to Wishlist'}
            </Button>
          </ModalFooter>
        </ModalContent>
      </Modal>

      {/* Delete Confirmation Dialog */}
      <AlertDialog
        isOpen={isDeleteOpen}
        leastDestructiveRef={cancelRef}
        onClose={onDeleteClose}
      >
        <AlertDialogOverlay>
          <AlertDialogContent>
            <AlertDialogHeader fontSize="lg" fontWeight="bold">
              Delete Item
            </AlertDialogHeader>

            <AlertDialogBody>
              Are you sure? This will permanently remove this item from your wishlist.
            </AlertDialogBody>

            <AlertDialogFooter>
              <Button ref={cancelRef} onClick={onDeleteClose}>
                Cancel
              </Button>
              <Button
                colorScheme="red"
                onClick={handleDeleteConfirm}
                ml={3}
                isLoading={deleteMutation.isPending}
              >
                Delete
              </Button>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialogOverlay>
      </AlertDialog>
    </Box>
  );
};

export default Wishlist;
